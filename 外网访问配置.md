# 外网访问配置指南

## 当前状态

- ✅ 局域网访问：已配置（同一WiFi/网络下的设备可以访问）
- ❌ 外网访问：需要额外配置

## 方案一：路由器端口转发（推荐，免费）

### 前提条件
1. 你的路由器有公网IP（不是内网IP，如 100.x.x.x）
2. 你有路由器管理员权限
3. 路由器支持端口转发功能

### 配置步骤

#### 1. 获取公网IP
```bash
# 在浏览器中访问
https://www.whatismyip.com/
# 或使用命令行
curl ifconfig.me
```

#### 2. 配置路由器端口转发

**登录路由器管理界面**（通常是 `192.168.1.1` 或 `192.168.0.1`）

**找到"端口转发"或"虚拟服务器"设置**，添加以下规则：

**规则1：前端端口（3000）**
- 服务名称：Basketball Frontend
- 外部端口：3000（或自定义，如 8080）
- 内部IP：192.168.31.38（你的服务器内网IP）
- 内部端口：3000
- 协议：TCP

**规则2：后端端口（8000）**
- 服务名称：Basketball Backend
- 外部端口：8000（或自定义，如 8081）
- 内部IP：192.168.31.38（你的服务器内网IP）
- 内部端口：8000
- 协议：TCP

#### 3. 配置前端API地址

如果前端和后端使用不同的外部端口，需要配置前端：

```bash
cd frontend
# 创建 .env 文件
echo "VITE_API_URL=http://你的公网IP:8000/api/v1" > .env
# 或者如果使用了自定义端口
echo "VITE_API_URL=http://你的公网IP:8081/api/v1" > .env
```

#### 4. 访问地址

- 前端：`http://你的公网IP:3000`
- 后端：`http://你的公网IP:8000/health`

### 注意事项

⚠️ **安全警告**：
- 暴露端口到公网存在安全风险
- 建议使用HTTPS（需要SSL证书）
- 考虑添加身份验证
- 定期更新系统和依赖

---

## 方案二：内网穿透工具（简单，但可能有限制）

### 2.1 使用 ngrok（免费版有限制）

#### 安装 ngrok
```bash
# macOS
brew install ngrok

# 或从官网下载
# https://ngrok.com/download
```

#### 启动隧道
```bash
# 终端1：启动后端隧道
ngrok http 8000

# 终端2：启动前端隧道
ngrok http 3000
```

#### 配置前端
```bash
cd frontend
# 使用ngrok提供的后端URL
echo "VITE_API_URL=https://xxxxx.ngrok.io/api/v1" > .env
```

**限制**：
- 免费版URL每次启动都会变化
- 有连接数限制
- 有流量限制

### 2.2 使用 Cloudflare Tunnel（免费，稳定）

```bash
# 安装 cloudflared
brew install cloudflared

# 创建隧道
cloudflared tunnel create basketball

# 配置隧道
cloudflared tunnel route dns basketball your-domain.com

# 启动隧道
cloudflared tunnel run basketball
```

### 2.3 使用 frp（自建服务器）

需要一台有公网IP的服务器作为中转。

---

## 方案三：云服务器部署（最稳定）

### 推荐平台
- 阿里云
- 腾讯云
- AWS
- DigitalOcean

### 部署步骤

1. **购买云服务器**（最低配置即可）
2. **配置安全组**（开放 3000 和 8000 端口）
3. **上传代码**
4. **安装依赖并启动服务**
5. **配置域名（可选）**

---

## 方案四：使用 Docker + 云服务（推荐生产环境）

### 使用 Docker Compose 部署

创建 `docker-compose.yml`：

```yaml
version: '3.8'

services:
  backend:
    build: ./backend
    ports:
      - "8000:8000"
    environment:
      - ALLOW_EXTERNAL=true
    volumes:
      - ./backend/database:/app/database

  frontend:
    build: ./frontend
    ports:
      - "3000:3000"
    environment:
      - VITE_API_URL=http://your-server-ip:8000/api/v1
    depends_on:
      - backend
```

---

## 快速测试外网访问

### 1. 检查端口是否开放

```bash
# 使用在线工具
https://www.yougetsignal.com/tools/open-ports/

# 或使用 telnet（在另一台外网设备上）
telnet 你的公网IP 3000
telnet 你的公网IP 8000
```

### 2. 测试后端API

```bash
curl http://你的公网IP:8000/health
```

### 3. 测试前端

在浏览器中访问：`http://你的公网IP:3000`

---

## 常见问题

### Q: 为什么配置了端口转发还是无法访问？
A: 检查以下几点：
1. 路由器是否有公网IP（不是运营商内网）
2. 防火墙是否允许端口
3. 运营商是否屏蔽了端口（某些运营商屏蔽80、8080等端口）
4. 前端API地址是否正确

### Q: 如何检查是否有公网IP？
A: 
```bash
# 查看路由器WAN口IP
# 登录路由器管理界面查看

# 对比公网IP
curl ifconfig.me
# 如果路由器WAN口IP和公网IP一致，说明有公网IP
```

### Q: 运营商没有公网IP怎么办？
A: 
1. 联系运营商申请公网IP（可能需要付费）
2. 使用内网穿透工具（ngrok、frp等）
3. 使用云服务器部署

### Q: 如何提高安全性？
A:
1. 使用HTTPS（Let's Encrypt免费证书）
2. 添加身份验证（JWT、OAuth等）
3. 使用防火墙限制访问IP
4. 定期更新系统和依赖
5. 使用反向代理（Nginx）隐藏真实端口

---

## 推荐方案

- **开发测试**：使用 ngrok 或 Cloudflare Tunnel
- **小规模使用**：路由器端口转发
- **生产环境**：云服务器 + Docker + HTTPS

